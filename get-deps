#!/usr/bin/env sh
set -eu

PREFIX="${PREFIX:-/usr/local}"

if command -v pkg-config >/dev/null 2>&1 && pkg-config --exists capstone; then
  echo "capstone already installed: $(pkg-config --modversion capstone)"
  exit 0
fi

tmpdir="$(mktemp -d)"
trap 'rm -rf "$tmpdir"' EXIT

echo "cloning capstone..."
git clone --depth 1 https://github.com/capstone-engine/capstone.git "$tmpdir/capstone"

echo "building capstone..."
make -C "$tmpdir/capstone"

echo "installing capstone to $PREFIX (requires sudo)..."
sudo make -C "$tmpdir/capstone" install PREFIX="$PREFIX"

if command -v ldconfig >/dev/null 2>&1; then
  sudo ldconfig
fi

echo "verifying pkg-config..."
if command -v pkg-config >/dev/null 2>&1; then
  if pkg-config --exists capstone; then
    echo "ok: capstone version $(pkg-config --modversion capstone)"
    echo "cflags: $(pkg-config --cflags capstone)"
    echo "libs:   $(pkg-config --libs capstone)"
  else
    echo "warning: pkg-config can't find capstone.pc."
    echo "if you installed to a non-standard prefix, set PKG_CONFIG_PATH accordingly."
  fi
else
  echo "warning: pkg-config not installed; install it for easiest Makefile integration."
fi
